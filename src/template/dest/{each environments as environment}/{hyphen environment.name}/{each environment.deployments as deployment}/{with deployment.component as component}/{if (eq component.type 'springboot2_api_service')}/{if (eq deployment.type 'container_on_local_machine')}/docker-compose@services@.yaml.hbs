  {{define 'service' component.function_model ~}}
  #
  # {{component.name}}
  #
  {{component.instance_name}}:
    build:
      context: ./{{component.instance_name}}
      dockerfile: Dockerfile
    container_name: {{component.instance_name}}
    ports:
    - '{{printf '%1$s:%1$s' component.port}}'
    expose:
    - '{{component.port}}'
    environment:
    {{#each component.datasource_mappings as |mapping|}}
    {{define 'datastore' mapping.component }}
    {{define "ENV_PREFIX" (concat
      'DATASOURCE'
      (if mapping.default '' (concat '_' (upper-snake mapping.name)))
    )}}
    - '{{ENV_PREFIX}}_URL={{datastore.r2dbc_connection_string}}'
    - '{{ENV_PREFIX}}_USER={{datastore.username}}'
    - '{{ENV_PREFIX}}_PASS={{datastore.password}}'
    {{/each}}
    {{#if service.depends_on_redis_cache ~}}
    {{define 'redis_server_deployment' (first (filter environment.deployments "(eq @it.component.type 'redis_server')")) ~}}
    - 'REDIS_HOST={{redis_server_deployment.component.instance_name}}'
    - 'REDIS_PORT={{redis_server_deployment.component.port}}'
    {{~/if}}
    {{#each component.external_rest_api_mappings as |mapping|}}
    {{define 'endpoint' mapping.external_rest_api_endpoint}}
    - '{{upper-snake (concat 'rest_client_' mapping.name '_base_url')}}={{endpoint.base_url}}'
    - '{{upper-snake (concat 'rest_client_' mapping.name '_api_key')}}={{endpoint.api_key}}'
    {{/each}}
    {{#each component.search_engine_mappings as |mapping|}}
    {{define 'search_engine' mapping.component ~}}
    - '{{upper-snake (concat 'search_engine_client_' mapping.name '_endpoints')}}={{search_engine.instance_name}}:{{search_engine.port}}'
    {{/each}}
    networks:
    - backend

  {{#each component.datasource_mappings as |mapping| ~}}
  {{define "datastore" mapping.component ~}}
  {{define "datasource" mapping.datasource ~}}
  {{define "migration_name" (concat
    component.instance_name '-' (hyphen datasource.name) '-datasource-migrate'
  )~}}
  {{migration_name}}:
    build:
      context: ./{{migration_name}}
      dockerfile: Dockerfile
    container_name: {{migration_name}}
    environment:
    - 'DATASOURCE_URL={{datastore.jdbc_connection_string}}'
    - 'DATASOURCE_USER={{datastore.username}}'
    - 'DATASOURCE_PASS={{datastore.password}}'
    networks:
    - backend
  {{/each}}

