  #
  # {{component.name}}
  #
  {{component.instance_name}}:
    build:
      context: ./{{component.instance_name}}
      dockerfile: Dockerfile
    container_name: {{component.instance_name}}
    ports:
    - '{{printf '%1$s:%1$s' component.port}}'
    expose:
    - '{{component.port}}'
    environment:
    {{#each component.datasource_mappings as |mapping|}}
    {{define 'datastore' mapping.component }}
    {{define "ENV_PREFIX" (concat
      'DATASOURCE'
      (if mapping.default '' (concat '_' (upper-snake mapping.name)))
    )}}
    - '{{ENV_PREFIX}}_URL={{datastore.r2dbc_connection_string}}'
    - '{{ENV_PREFIX}}_USER={{datastore.username}}'
    - '{{ENV_PREFIX}}_PASS={{datastore.password}}'
    {{/each}}
    {{#each component.http_client_settings as |setting|}}
    {{define "ENV_PREFIX" (concat 'HTTP_CLIENT_' (upper-snake setting.name))}}
    - '{{ENV_PREFIX}}_BASE_URL={{setting.base_url}}'
    - '{{ENV_PREFIX}}_API_KEY={{setting.api_key}}'
    {{/each}}

    networks:
    - backend

  {{#each component.datasource_mappings as |mapping| ~}}
  {{define "datastore" mapping.component ~}}
  {{define "datasource" mapping.datasource ~}}
  {{define "migration_name" (concat
    component.instance_name '-' (hyphen datasource.name) '-datasource-migrate'
  )~}}
  {{migration_name}}:
    build:
      context: ./{{migration_name}}
      dockerfile: Dockerfile
    container_name: {{migration_name}}
    environment:
    - 'DATASOURCE_URL={{datastore.jdbc_connection_string}}'
    - 'DATASOURCE_USER={{datastore.username}}'
    - 'DATASOURCE_PASS={{datastore.password}}'
    networks:
    - backend
  {{/each}}

