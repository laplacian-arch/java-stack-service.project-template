  {{define 'service' component.function_model ~}}
  #
  # {{component.name}}
  #
  {{component.instance_name}}:
    build:
      context: ./{{component.instance_name}}
      dockerfile: Dockerfile
    container_name: {{component.instance_name}}
    ports:
    - '{{printf '%1$s:%1$s' component.port}}'
    {{#if component.enable_jmx ~}}
    - '{{printf '%1$s:%1$s' '9010'}}'
    {{/if}}
    expose:
    - '{{component.port}}'
    {{#if component.enable_jmx ~}}
    - 9010
    {{/if}}
    environment:
    {{#each component.datasource_mappings as |mapping|}}
    {{define 'datastore' mapping.component }}
    {{define "ENV_PREFIX" (concat
      'DATASOURCE'
      (if mapping.default '' (concat '_' (upper-snake mapping.name)))
    )}}
    - '{{ENV_PREFIX}}_URL={{datastore.r2dbc_connection_string}}'
    - '{{ENV_PREFIX}}_USER={{datastore.username}}'
    - '{{ENV_PREFIX}}_PASS={{datastore.password}}'
    {{/each}}
    {{#if service.depends_on_redis_cache ~}}
    {{define 'redis_server_deployment' (first (filter environment.deployments "(eq @it.component.type 'redis_server')")) ~}}
    - 'REDIS_HOST={{redis_server_deployment.component.instance_name}}'
    - 'REDIS_PORT={{redis_server_deployment.component.port}}'
    {{~/if}}
    {{#each service_configurations as |config| ~}}
    - '{{config.environment_variable_name}}={{trim config.default_value}}'
    {{/each}}
    networks:
    - backend

  {{#each component.datasource_mappings as |mapping| ~}}
  {{define "datastore" mapping.component ~}}
  {{define "datasource" mapping.datasource ~}}
  {{define "migration_name" (concat
    component.instance_name '-' (hyphen datasource.name) '-datasource-migrate'
  )~}}
  {{migration_name}}:
    build:
      context: ./{{migration_name}}
      dockerfile: Dockerfile
    container_name: {{migration_name}}
    environment:
    - 'DATASOURCE_URL={{datastore.jdbc_connection_string}}'
    - 'DATASOURCE_USER={{datastore.username}}'
    - 'DATASOURCE_PASS={{datastore.password}}'
    networks:
    - backend
  {{/each}}

